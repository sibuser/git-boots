#!/bin/bash
# Copyright (c) 2012, Alexander Krasnukhin <the.malkolm@gmail.com>

YEAR="$(date +%Y)"
AUTHOR="$(git config --get user.name)"
EMAIL="$(git config --get user.email)"
COPYRIGHT="Copyright (c) $YEAR, $NAME <$EMAIL>"

sh_setup () {
    echo "$(dirname $(readlink -e $0))/git-utils"
}

clean () {
    sed -i 's/\t/    /g' "$@"
    sed -i 's/[ \t]*$//g' "$@"
}

copyright () {
    sed -i -n "
1 {
# read extra line
    N
# check Copyright present
    s:Copyright:&:
# skip if so
    t skip
# print header
    P
# insert missing copyright
    i\
# $COPYRIGHT
# delete header & next cycle
    D
    :skip
# print header & delete it
    P;D
}
1 ! {
    p
}
" "$@"
}

template () {
template=$(cat << EOF
#!/bin/bash
# $COPYRIGHT

. "\$(git boots --sh-setup)"

set -e

# a  - simple
# b: - with arg (\$OPTARG)
while getopts "" flag; do
    case $flag in
        :|\?)
            usage
            ;;
    esac
done
shift $((OPTIND - 1))
EOF
)
echo "$template"
}

case "$1" in
    --sh-setup)
        shift
        sh_setup "$@"
        ;;
    --clean)
        shift
        clean "$@"
        ;;
    --copyright)
        shift
        copyright "$@"
        ;;
    --template)
        shift
        template "$@"
        ;;
    *)
        error "Invalid argument"
        exit 1
esac
