#!/bin/bash
# Copyright (c) 2012, Alexander Krasnukhin <the.malkolm@gmail.com>

test "$1" != "--sh-setup" &&
. "$(git boots --sh-setup)"

GIT_ALIASES=$(cat << EOF
append          commit --amend -C HEAD
last            log -n 1
index           diff --cached
incoming        log ...@{u}
outgoing        log @{u}...
new             log $1@{1}..$1@{0}
empty-tree-sha1 hash-object -t tree /dev/null
stash-unapply   git stash show -p | git apply -R
EOF
)

GIT_TEMPLATE=$(cat << EOF
#!/bin/bash
# $GIT_COPYRIGHT

. "\$(git boots --sh-setup)"

set -e

# a  - simple
# b: - with arg (\$OPTARG)
while getopts "" flag; do
    case $flag in
        :|\?)
            usage
            ;;
    esac
done
shift $((OPTIND - 1))
EOF
)

boots_dir () {
    echo "$(dirname $(readlink -e $0))"
}

sh_setup () {
    echo "$(boots_dir)/git-utils"
}

aliases_setup () {
    echo "$GIT_ALIASES" | \
        sed '/^[ \t]*(#|$)/ d' | \
        while read line;
    do
        alias=$(echo "$line"   | awk '{print $1}')
        command=$(echo "$line" | awk '{$1="";print}')
        if git config --get alias.$alias >/dev/null
        then
            err "git-$alias is already set, skip"
            continue
        fi
        git config "$@" alias."$alias" "\"$command\""
        say "git-$alias is set"
    done
}

clean () {
    sed -i 's/\t/    /g' "$@"
    sed -i 's/[ \t]*$//g' "$@"
}

copyright () {
    sed -i -n "
1 {
# read extra line
    N
# check Copyright present
    s:Copyright:&:
# skip if so
    t skip
# print header
    P
# insert missing copyright
    i\
# $GIT_COPYRIGHT
# delete header & next cycle
    D
    :skip
# print header & delete it
    P;D
}
1 ! {
    p
}
" "$@"
}

template () {
    echo "$GIT_TEMPLATE"
}

# TODO add todo to the custom file
boots_todo() {
    awk '/TODO/ && !/awk/ {printf "%-12s : %s\n", FILENAME, $0}' $(ls "$(git boots --dir)")
}

case "$1" in
    --sh-setup)
        shift
        sh_setup "$@"
        ;;
    --aliases-setup)
        shift
        aliases_setup "$@"
        ;;
    --clean)
        shift
        clean "$@"
        ;;
    --copyright)
        shift
        copyright "$@"
        ;;
    --template)
        shift
        template "$@"
        ;;
    --dir)
        shift
        boots_dir "$@"
        ;;
    --todo)
        shift
        boots_todo "$@"
        ;;
    *)
        usage
        ;;
esac
