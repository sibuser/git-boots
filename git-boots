#!/bin/bash
# Copyright (c) 2012, Alexander Krasnukhin <the.malkolm@gmail.com>

GIT_ALIASES=$(cat << EOF
append          commit --amend -C HEAD
last            log -n 1
index           diff --cached
incoming        log ...@{u}
outgoing        log @{u}...
new             log $1@{1}..$1@{0}
empty-tree-sha1 hash-object -t tree /dev/null
stash-unapply   git stash show -p | git apply -R
EOF
)

YEAR="$(date +%Y)"
AUTHOR="$(git config --get user.name)"
EMAIL="$(git config --get user.email)"
COPYRIGHT="Copyright (c) $YEAR, $NAME <$EMAIL>"

test "$1" != "--sh-setup" &&
. "$(git boots --sh-setup)"

sh_setup () {
    echo "$(dirname $(readlink -e $0))/git-utils"
}

aliases_setup () {
    echo "$GIT_ALIASES" | \
        sed '/^[ \t]*(#|$)/ d' | \
        while read line;
    do
        alias=$(echo "$line"   | awk '{print $1}')
        command=$(echo "$line" | awk '{print substr($0,index($0,$2))}')
        if git config --get alias.$alias >/dev/null
        then
            err "git-$alias is already set, skip"
            continue
        fi
        git config "$@" alias."$alias" "\"$command\""
        say "git-$alias is set"
    done
}

clean () {
    sed -i 's/\t/    /g' "$@"
    sed -i 's/[ \t]*$//g' "$@"
}

copyright () {
    sed -i -n "
1 {
# read extra line
    N
# check Copyright present
    s:Copyright:&:
# skip if so
    t skip
# print header
    P
# insert missing copyright
    i\
# $COPYRIGHT
# delete header & next cycle
    D
    :skip
# print header & delete it
    P;D
}
1 ! {
    p
}
" "$@"
}

template () {
    template=$(cat << EOF
#!/bin/bash
# $COPYRIGHT

. "\$(git boots --sh-setup)"

set -e

# a  - simple
# b: - with arg (\$OPTARG)
while getopts "" flag; do
    case $flag in
        :|\?)
            usage
            ;;
    esac
done
shift $((OPTIND - 1))
EOF
    )
    echo "$template"
}

case "$1" in
    --sh-setup)
        shift
        sh_setup "$@"
        ;;
    --aliases-setup)
        shift
        aliases_setup "$@"
        ;;
    --clean)
        shift
        clean "$@"
        ;;
    --copyright)
        shift
        copyright "$@"
        ;;
    --template)
        shift
        template "$@"
        ;;
    *)
        die "Invalid argument"
        exit 1
esac
